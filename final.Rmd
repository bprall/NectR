---
title: "Module 7 Project"
author: "Group"
date: "2023-12-15"
output: html_document
---

# Introduction

# Methods

# Results

```{r setup, echo=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(MuMIn)
library(effects)
library(car)
library(broom)

colony_data <- read.csv("Colony.csv")
stressor_data <- read.csv("Stressor.csv")
```

``` {r data prep, echo=FALSE, warning=FALSE}
# Function to expand rows with month ranges
expand_months <- function(row, toggle) {
  year <- row$year
  state <- row$state

  # Extract start and end months
  months_range <- strsplit(as.character(row$months), "-")[[1]]
  start_month <- match(months_range[1], month.name)
  end_month <- match(months_range[length(months_range)], month.name)

  # Generate a sequence of months
  expanded_months <- seq(as.Date(paste(year, start_month, "01", sep = "-")),
                         as.Date(paste(year, end_month, "01", sep = "-")),
                         by = "1 month")

  # Create a data frame with expanded rows for stressor
  if (toggle == 0) {
    data.frame(
      year = row$year,
      month = format(expanded_months, "%B"),
      state = rep(state, length(expanded_months)),
      stressor = row$stressor,
      stress_pct = row$stress_pct
    )
    # Create a data frame with expanded rows for colony
  } else {
    data.frame(
      year = row$year,
      month = format(expanded_months, "%B"),
      state = rep(state, length(expanded_months)),
      colony_n = row$colony_n,
      colony_max = row$colony_max,
      colony_lost = row$colony_lost,
      colony_lost_pct = row$colony_lost_pct,
      colony_added = row$colony_added,
      colony_reno = row$colony_reno,
      colony_reno_pct = row$colony_reno_pct
    )
  }
}

# Apply the function to each row of stressors
expanded_stressor_data <- stressor_data %>%
  rowwise() %>%
  do(expand_months(.,0))

# Combine the expanded data with the original data
new_stressor_data <- bind_rows(expanded_stressor_data)

expanded_colony_data <- colony_data %>%
  rowwise() %>%
  do(expand_months(.,1))

# Combine the expanded data with the original data
new_colony_data <- bind_rows(expanded_colony_data)

merged_data_with_total <- left_join(new_colony_data, new_stressor_data, by = c("year", "month", "state"))

merged_data <- merged_data_with_total %>% 
  filter(state != "United States") %>%
  mutate(stressor = ifelse(stressor == "Disesases", "Diseases", stressor)) %>%
  distinct() %>%
  na.omit()

selected_columns <- merged_data %>%
  select(state, year, month, stressor, colony_lost, colony_lost_pct, stress_pct)
```

``` {r graphs, echo=FALSE, warning=FALSE}
# Graph of Colony Losses by State
ggplot(merged_data, aes(x = state, y = colony_lost, fill = state)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_blank()) +
  labs(title = "Colony Losses by State",
       x = "State",
       y = "Colonies Lost")

# Visualize the distribution of colony losses
ggplot(merged_data, aes(x = colony_lost_pct)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Colony Loss Percentage",
       x = "Colony Loss Percentage",
       y = "Frequency")

ggplot(merged_data, aes(x = stress_pct, y = colony_lost_pct, color = stressor)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Relationship between Stress Percentage and Colony Loss",
       x = "Stress Percentage",
       y = "Colony Loss Percentage") + 
  theme_minimal()
```

``` {r models, echo=FALSE}
# Create a linear model with interaction terms
model1 <- lm(colony_lost_pct ~ stress_pct * stressor, data = selected_columns)
model2 <- lm(colony_lost_pct ~ month, data = selected_columns)
model3 <- lm(colony_lost_pct ~ stress_pct * stressor + stressor * month, data = selected_columns)
model4 <- lm(colony_lost_pct ~ stress_pct * stressor * month, data = selected_columns)

summary(model1)$adj.r.squared
summary(model2)$adj.r.squared
summary(model3)$adj.r.squared
summary(model4)$adj.r.squared

# Tidy up the model results
tidy_model1 <- tidy(model1, conf.int=TRUE)

tidy_model2 <- tidy(model2, conf.int=TRUE)

tidy_model2 <- tidy_model2 %>%
  filter(term != "(Intercept)")

tidy_model1 <- tidy_model1 %>%
  filter(term != "(Intercept)")

tidy_model2$term <- str_remove(tidy_model2$term, "month")

tidy_model1$term <- str_remove(tidy_model1$term, "stressor")

stressor_tidy_model <- tidy_model1 %>%
  filter(!grepl("stress_pct", term))

interaction_tidy_model <- tidy_model1 %>%
  filter(grepl(":", term))

# Visualize Stressor impact on colonies
ggplot(stressor_tidy_model, aes(x = term, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(width = 0.2, position = position_dodge(width = 0.5)) +
  labs(title = "Effect of Stressors on Colony Lost Percentage",
       x = "Stressor",
       y = "Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Visualize Stressor and Stress Percentage Interaction
ggplot(interaction_tidy_model, aes(x = term, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(width = 0.2, position = position_dodge(width = 0.5)) +
  labs(title = "Effect of Stressors and Stress Percentage on Colony Lost Percentage",
       x = "Stressor",
       y = "Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Visualize month impact on colonies
ggplot(tidy_model2, aes(x = term, y = estimate, ymin = conf.low, ymax = conf.high)) +
  geom_point(position = position_dodge(width = 0.5)) +
  geom_errorbar(width = 0.2, position = position_dodge(width = 0.5)) +
  labs(title = "Effect of Month on Colony Lost Percentage",
       x = "Month",
       y = "Estimate") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Discussion

# Contributions
