---
title: "Module 7 Project"
author: "Group"
date: "2023-12-15"
output: html_document
---

```{r setup, echo=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library(MuMIn)
library(effects)
library(car)
library(broom)
library(knitr)
library(kableExtra)

colony_data <- read.csv("Colony.csv")
stressor_data <- read.csv("Stressor.csv")
```



``` {r data prep, echo=FALSE, warning=FALSE}
# Function to expand rows with month ranges
expand_months <- function(row, toggle) {
  year <- row$year
  state <- row$state

  # Extract start and end months
  months_range <- strsplit(as.character(row$months), "-")[[1]]
  start_month <- match(months_range[1], month.name)
  end_month <- match(months_range[length(months_range)], month.name)

  # Generate a sequence of months
  expanded_months <- seq(as.Date(paste(year, start_month, "01", sep = "-")),
                         as.Date(paste(year, end_month, "01", sep = "-")),
                         by = "1 month")

  # Create a data frame with expanded rows for stressor
  if (toggle == 0) {
    data.frame(
      year = row$year,
      month = format(expanded_months, "%B"),
      state = rep(state, length(expanded_months)),
      stressor = row$stressor,
      stress_pct = row$stress_pct
    )
    # Create a data frame with expanded rows for colony
  } else {
    data.frame(
      year = row$year,
      month = format(expanded_months, "%B"),
      state = rep(state, length(expanded_months)),
      colony_n = row$colony_n,
      colony_max = row$colony_max,
      colony_lost = row$colony_lost,
      colony_lost_pct = row$colony_lost_pct,
      colony_added = row$colony_added,
      colony_reno = row$colony_reno,
      colony_reno_pct = row$colony_reno_pct
    )
  }
}

# Apply the function to each row of stressors
expanded_stressor_data <- stressor_data %>%
  rowwise() %>%
  do(expand_months(.,0))

# Combine the expanded data with the original data
new_stressor_data <- bind_rows(expanded_stressor_data)

expanded_colony_data <- colony_data %>%
  rowwise() %>%
  do(expand_months(.,1))

# Combine the expanded data with the original data
new_colony_data <- bind_rows(expanded_colony_data)

# Combine colony and stressor data
merged_data_with_total <- left_join(new_colony_data, new_stressor_data, by = c("year", "month", "state"))

# Get rid of total value
merged_data <- merged_data_with_total %>% 
  filter(state != "United States") %>%
  mutate(stressor = ifelse(stressor == "Disesases", "Diseases", stressor)) %>%
  distinct() %>%
  na.omit()

# Columns we will use for analysis
selected_columns <- merged_data %>%
  select(state, year, month, stressor, colony_lost, colony_lost_pct, stress_pct)
```




# Introduction



# Methods




``` {r graphs, echo=FALSE, warning=FALSE, message=FALSE}
# Visualize the distribution of colony losses
ggplot(merged_data, aes(x = colony_lost_pct)) +
  geom_histogram(binwidth = 5, fill = "blue", color = "black", alpha = 0.7) +
  labs(title = "Distribution of Colony Loss Percentage",
       x = "Colony Loss Percentage",
       y = "Frequency")

# Visualize relationship between Stress Percentage and Colony Loss Percentage
ggplot(merged_data, aes(x = stress_pct, y = colony_lost_pct)) +
  geom_point() +
  geom_smooth(se = FALSE, method = "lm", color = "red") +
  labs(title = "Relationship between Stress Percentage and Colony Loss",
       x = "Stress Percentage",
       y = "Colony Loss Percentage") + 
  theme_minimal()

# Graph of Colony Losses by State
ggplot(merged_data, aes(x = state, y = colony_lost_pct, fill = state)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_blank()) +
  labs(title = "Colony Loss Percentage by State",
       x = "State",
       y = "Colonies Lost")

# Graph function for column correlation w/ Colony Loss percentage
create_correlation_plot <- function(x_variable) {
  # Calculate the mean and standard deviation within the ggplot code
  plot <- ggplot(selected_columns, aes_string(x = x_variable, y = "colony_lost_pct")) +
    stat_summary(fun.data = "mean_se", geom = "point", position = position_dodge(width = 0.5)) +
    stat_summary(fun.data = "mean_se", geom = "errorbar", position = position_dodge(width = 0.5)) +
    labs(title = paste("Correlation between", x_variable, "and Colony Lost Percentage"),
         x = x_variable,
         y = "Colony Lost Percentage") +
    theme_minimal() + 
    theme(axis.text.x = element_text(angle = 45, hjust = 1))

  return(plot)
}

create_correlation_plot("stressor")
create_correlation_plot("month")
```




# Results





``` {r models, echo=FALSE}
# Create linear models
model1 <- lm(colony_lost_pct ~ stress_pct * stressor, data = selected_columns)
model2 <- lm(colony_lost_pct ~ state * month, data = selected_columns)
model3 <- lm(colony_lost_pct ~ state * month + stressor, data = selected_columns)
model4 <- lm(colony_lost_pct ~ state * month + stress_pct * stressor, data = selected_columns)

# Compare models
summary_table <- data.frame(
  Model = c("Model 1", "Model 2", "Model 3", "Model 4"),
  R_squared = c(summary(model1)$r.squared, summary(model2)$r.squared, 
                summary(model3)$r.squared, summary(model4)$r.squared),
  Adjusted_R_squared = c(summary(model1)$adj.r.squared, summary(model2)$adj.r.squared, 
                         summary(model3)$adj.r.squared, summary(model4)$adj.r.squared),
  MSE = c(mean(resid(model1)^2), mean(resid(model2)^2),
          mean(resid(model3)^2), mean(resid(model4)^2)),
  AIC = c(AIC(model1), AIC(model2), AIC(model3), AIC(model4)),
  BIC = c(BIC(model1), BIC(model2), BIC(model3), BIC(model4))
)

summary_table_kable <- kable(summary_table, format = "html") %>%
  kable_styling(full_width = FALSE) %>%
  row_spec(0, bold = TRUE, color = "white", background = "blue")

summary_table_kable
```



# Discussion



# Contributions


